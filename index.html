<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UiTM E-Course Portal (Responsive)</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --uitm-purple: #4b0082;
            --uitm-light-purple: #6a1b9a;
            --uitm-gold: #ffc107;
            --bg-color: #f4f6f9;
            --text-color: #333;
            --sidebar-width: 250px;
            --success: #28a745;
            --danger: #dc3545;
            --info: #17a2b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* --- SIDEBAR (Responsive) --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--uitm-purple);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: transform 0.3s ease;
            left: 0; top: 0;
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 900;
        }

        .brand { padding: 20px; font-size: 1.5rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;}
        .brand img { height: 40px; max-width: 100%; object-fit: contain; }
        .brand span { color: var(--uitm-gold); }
        .close-sidebar-btn { display: none; background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }

        .nav-links { list-style: none; padding-top: 20px; }
        .nav-links li a {
            display: flex; align-items: center; padding: 15px 20px;
            color: rgba(255,255,255,0.8); text-decoration: none; cursor: pointer; transition: 0.3s;
        }
        .nav-links li a:hover, .nav-links li a.active {
            background: var(--uitm-light-purple); color: white; border-left: 4px solid var(--uitm-gold);
        }
        .nav-links li a i { margin-right: 15px; width: 20px; text-align: center; }

        /* --- MAIN CONTENT --- */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 20px;
            width: 100%;
            transition: margin-left 0.3s ease;
        }

        /* --- HEADER --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; background: white; padding: 15px 25px;
            border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .hamburger { display: none; font-size: 1.5rem; cursor: pointer; color: var(--uitm-purple); margin-right: 15px; }
        .header-left { display: flex; align-items: center; }
        .mobile-logo { height: 30px; display: none; cursor: pointer; }

        .notification-bell { position: relative; cursor: pointer; font-size: 1.2rem; margin-right: 15px;}
        .badge {
            position: absolute; top: -5px; right: -5px; background: red;
            color: white; font-size: 0.7rem; padding: 2px 5px; border-radius: 50%;
        }

        /* --- UTILITIES --- */
        .view-section { display: none; animation: fadeIn 0.4s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; transition: 0.2s; font-weight: 500; font-size: 0.9rem;}
        .btn-primary { background: var(--uitm-purple); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-outline { border: 1px solid var(--uitm-purple); color: var(--uitm-purple); background: transparent; }
        .btn-success { background: var(--success); color: white; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .progress-bar-bg { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; background: var(--uitm-light-purple); width: 0%; transition: width 1s ease; }

        /* --- RESPONSIVE TABLE --- */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px; /* Forces scroll on small screens */ }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; color: #444; white-space: nowrap;}

        /* --- MODALS --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000;
            padding: 20px;
        }
        .modal.open { display: flex; }
        .modal-content { 
            background: white; padding: 25px; border-radius: 10px; width: 500px; max-width: 100%; 
            position: relative; max-height: 90vh; overflow-y: auto; 
        }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;
        }
        .close-btn { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.2rem; }

        /* Course Details Specifics */
        .detail-row { display: flex; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .detail-label { font-weight: bold; width: 120px; color: #555; }
        .detail-value { flex: 1; color: var(--uitm-purple); font-weight: 600; }

        /* --- CHAT BOX --- */
        .chat-box {
            position: fixed; bottom: 90px; right: 30px; width: 320px; height: 400px;
            background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none; flex-direction: column; overflow: hidden; z-index: 1500;
        }
        .chat-header { background: var(--uitm-purple); color: white; padding: 15px; display: flex; justify-content: space-between; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px; }
        .chat-footer { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; }
        .chat-msg { padding: 8px 12px; border-radius: 15px; max-width: 80%; font-size: 0.9rem; }
        .msg-user { background: var(--uitm-light-purple); color: white; align-self: flex-end; }
        .msg-bot { background: #eee; color: #333; align-self: flex-start; }

        .fab-support {
            position: fixed; bottom: 30px; right: 30px; background: var(--uitm-gold);
            color: var(--uitm-purple); width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 1000; transition: transform 0.2s;
        }

        /* --- MEDIA QUERIES FOR RESPONSIVENESS --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 260px; }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .close-sidebar-btn { display: block; }
            
            .main-content { margin-left: 0; padding: 15px; }
            
                        .hamburger { display: block; }
            
                        .mobile-logo { display: block; }
            
                        .header-title h2 { font-size: 1.2rem; }
            .header-title p { font-size: 0.75rem; }

            /* Adjust Modal for Mobile */
            .modal-content { width: 95%; padding: 15px; }
            
            /* Chat Box Full Screen on very small devices */
            .chat-box { width: 90%; right: 5%; bottom: 100px; height: 50vh; }
            .fab-support { width: 50px; height: 50px; font-size: 20px; bottom: 20px; right: 20px; }
        }
    </style>
</head>
<body>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="brand" onclick="switchView('dashboard'); toggleSidebarIfMobile()" style="cursor: pointer;">
            <img src="logo.png" alt="UiTM eCourse Logo">
            <button class="close-sidebar-btn" onclick="event.stopPropagation(); toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <ul class="nav-links">
            <li><a onclick="switchView('dashboard'); toggleSidebarIfMobile()" id="nav-dashboard" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a onclick="switchView('register'); toggleSidebarIfMobile()" id="nav-register"><i class="fas fa-book"></i> Register Course</a></li>
            <li><a onclick="switchView('financial'); toggleSidebarIfMobile()" id="nav-financial"><i class="fas fa-money-bill-wave"></i> Financial</a></li>
            <li><a onclick="switchView('settings'); toggleSidebarIfMobile()" id="nav-settings"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header>
            <div class="header-left">
                <div class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
                <img src="logo.png" alt="UiTM Logo" class="mobile-logo" onclick="switchView('dashboard')">
            </div>
            <div class="user-info" style="display:flex; align-items:center;">
                <div class="notification-bell" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="badge">2</span>
                </div>
                <div class="profile-pic" onclick="toggleProfileMenu()" style="width: 35px; height: 35px; background: #ddd; border-radius: 50%; display:flex; align-items:center; justify-content:center; cursor: pointer;">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </header>

        <!-- VIEW: DASHBOARD -->
        <section id="view-dashboard" class="view-section active">
            <div class="dashboard-grid">
                <!-- Real-time Tracker -->
                <div class="card">
                    <div class="card-header">
                        <h3>Real-Time Seats</h3>
                        <i class="fas fa-sync fa-spin" style="color:var(--uitm-purple)"></i>
                    </div>
                    <div id="tracker-container">
                        <div style="margin-bottom:15px;">
                            <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                                <span>CSC577 - Software Eng.</span> <span id="seat-1">24/30</span>
                            </div>
                            <div class="progress-bar-bg"><div id="bar-1" class="progress-bar" style="width:80%"></div></div>
                        </div>
                        <div>
                            <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                                <span>ENT530 - Entrepreneur</span> <span id="seat-2">85/100</span>
                            </div>
                            <div class="progress-bar-bg"><div id="bar-2" class="progress-bar" style="width:85%; background:var(--uitm-gold)"></div></div>
                        </div>
                    </div>
                </div>

                <!-- My Registered Courses (NEW) -->
                <div class="card">
                    <div class="card-header">
                        <h3>My Courses</h3>
                        <span class="badge" style="background:var(--success); position:static;" id="dashboard-course-count">0</span>
                    </div>
                    <ul id="dashboard-course-list" style="list-style: none; font-size: 0.9rem;">
                        <li style="color: #999; text-align: center; padding: 10px;">No courses registered yet.</li>
                    </ul>
                </div>

                <!-- Fees Shortcut -->
                <div class="card">
                    <div class="card-header"><h3>Financial Status</h3></div>
                    <div style="text-align:center; padding:10px; background:#fff3cd; color:#856404; border-radius:5px; margin-bottom:15px;">
                        Balance: <strong id="dash-balance">RM 540.00</strong>
                    </div>
                    <button class="btn btn-primary" style="width:100%" onclick="switchView('financial')">Manage Finances</button>
                </div>

                <!-- Deadline -->
                <div class="card">
                    <div class="card-header"><h3>Add/Drop Deadline</h3></div>
                    <div style="text-align:center; background:var(--uitm-purple); color:white; padding:15px; border-radius:8px;">
                        <div id="timer" style="font-size:1.5rem; font-weight:bold;">Loading...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: REGISTER COURSE -->
        <section id="view-register" class="view-section">
            <div class="card">
                <div class="card-header">
                    <h3>Course Registration</h3>
                    <span>Credits: <strong id="credit-hours">0</strong></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="course-search" onkeyup="filterCourses()" placeholder="Search by code or name..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Course Name</th>
                                <th>Group</th>
                                <th>Details</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="course-table">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top:20px; text-align:right;">
                    <button class="btn btn-primary" onclick="openValidationModal()">Validate & Confirm</button>
                </div>
            </div>
        </section>

        <!-- VIEW: FINANCIAL -->
        <section id="view-financial" class="view-section">
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header"><h3>Outstanding Fees</h3></div>
                    <h1 style="text-align:center; margin:20px 0; color:var(--danger);" id="full-balance">RM 540.00</h1>
                    <div style="display:flex; gap:10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" style="flex:1; min-width: 120px;" onclick="openPaymentModal()">Pay Now (FPX)</button>
                        <button class="btn btn-outline" style="flex:1; min-width: 120px;" onclick="openDeferModal()">Deferment</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>Manual Processing</h3></div>
                    <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">Upload proof of sponsorship/Zakat.</p>
                    <button class="btn btn-outline" style="width:100%; border-style:dashed;" onclick="document.getElementById('doc-upload').click()">
                        <i class="fas fa-cloud-upload-alt"></i> Upload Document
                    </button>
                    <input type="file" id="doc-upload" hidden onchange="alert('File uploading...')">
                </div>
            </div>
        </section>

        <!-- VIEW: SETTINGS -->
        <section id="view-settings" class="view-section">
            <div class="card">
                <div class="card-header">
                    <h3>Settings</h3>
                </div>
                <div style="padding: 10px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <span><i class="fas fa-moon" style="margin-right: 10px;"></i> Dark Mode</span>
                        <label class="switch" style="position: relative; display: inline-block; width: 50px; height: 24px;">
                            <input type="checkbox" id="toggle-darkmode">
                            <span class="slider round" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
                        </label>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <span><i class="fas fa-envelope" style="margin-right: 10px;"></i> Email Notifications</span>
                        <label class="switch" style="position: relative; display: inline-block; width: 50px; height: 24px;">
                            <input type="checkbox" checked>
                            <span class="slider round" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
                        </label>
                    </div>
                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                    <button class="btn btn-primary" onclick="saveSettings()" id="btn-save-settings" style="width: 100%;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>
            
            <style>
                /* Embedded Switch Styles for Prototype */
                .switch input { opacity: 0; width: 0; height: 0; }
                .slider:before {
                    position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;
                }
                input:checked + .slider { background-color: var(--uitm-purple); }
                input:checked + .slider:before { transform: translateX(26px); }
            </style>
        </section>
    </div>

    <!-- SUPPORT CHAT -->
    <div class="fab-support" onclick="toggleChat()"><i class="fas fa-headset"></i></div>
    
    <div class="chat-box" id="chat-box">
        <div class="chat-header">
            <span>UiTM Live Support</span>
            <i class="fas fa-times" style="cursor:pointer;" onclick="toggleChat()"></i>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="chat-msg msg-bot">Hello! How can I help you today?</div>
        </div>
        <div class="chat-footer">
            <input type="text" id="chat-input" placeholder="Type a message..." style="width:100%; border:1px solid #ddd; padding:5px; border-radius:5px;">
            <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- MODAL: COURSE DETAILS (NEW FEATURE) -->
    <div class="modal" id="courseModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('courseModal')">&times;</span>
            <h3 style="color:var(--uitm-purple); margin-bottom: 20px;">Course Timetable</h3>
            
            <div id="course-details-content">
                <!-- Injected via JS -->
            </div>

            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-outline" onclick="closeModal('courseModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- MODAL: DEFERMENT -->
    <div class="modal" id="deferModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('deferModal')">&times;</span>
            <h3>Apply for Deferment</h3>
            <select><option>Financial Constraints</option><option>Medical Reasons</option></select>
            <textarea rows="3" placeholder="Remarks..."></textarea>
            <button class="btn btn-primary" style="width:100%" onclick="closeModal('deferModal'); alert('Submitted!')">Submit</button>
        </div>
    </div>

    <!-- MODAL: PAYMENT -->
    <div class="modal" id="payModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('payModal')">&times;</span>
            <h3>Secure Payment Gateway</h3>
            <p style="margin-bottom:10px;">Amount: <strong>RM 540.00</strong></p>
            <select><option>Maybank2U</option><option>CIMB Clicks</option></select>
            <button class="btn btn-primary" style="width:100%" onclick="processPayment()">Proceed</button>
        </div>
    </div>

    <!-- MODAL: REGISTRATION SLIP -->
    <div class="modal" id="validationModal">
        <div class="modal-content" style="text-align: center;">
            <span class="close-btn" onclick="closeModal('validationModal')">&times;</span>
            <img src="logo.png" alt="UiTM Logo" style="height: 50px; margin-bottom: 15px;">
            <div style="font-size: 3rem; color: var(--success); margin-bottom: 10px;"><i class="fas fa-check-circle"></i></div>
            <h3>Registration Successful!</h3>
            <p style="color: #666; margin: 10px 0;">Your course registration slip has been generated.</p>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; text-align: left; font-size: 0.9rem;">
                <p><strong>Ref ID:</strong> REF-2023-8892</p>
                <p><strong>Date:</strong> <span id="slip-date"></span></p>
                <p><strong>Total Credits:</strong> <span id="slip-credits">0</span></p>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="closeModal('validationModal')">Download PDF</button>
        </div>
    </div>

    <!-- MODAL: PROFILE (Simple Dropdown Simulation) -->
    <div class="modal" id="profileModal">
        <div class="modal-content" style="width: 300px;">
            <span class="close-btn" onclick="closeModal('profileModal')">&times;</span>
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 80px; height: 80px; background: #ddd; border-radius: 50%; margin: 0 auto 10px; display:flex; align-items:center; justify-content:center; font-size: 2rem; color: #666;">
                    <i class="fas fa-user"></i>
                </div>
                <h4>Student Name</h4>
                <p style="color: #666; font-size: 0.9rem;">2023456789</p>
            </div>
            <button class="btn btn-outline" style="width: 100%; margin-bottom: 10px;" onclick="switchView('settings'); closeModal('profileModal')">Settings</button>
            <button class="btn btn-danger" style="width: 100%; background: #dc3545; color: white;" onclick="alert('Logged out successfully.'); window.location.reload();">Logout</button>
        </div>
    </div>

    <script>
        // --- 1. RESPONSIVE SIDEBAR LOGIC ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        function toggleSidebarIfMobile() {
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // --- 2. NAVIGATION ---
        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewName).classList.add('active');
            document.getElementById('nav-' + viewName).classList.add('active');
        }

        // --- 3. COURSE DATA & DETAILS (NEW FEATURE) ---
        // Enhanced Data Structure
        const availableCourses = [
            { 
                code: "CSC577", 
                name: "Software Engineering", 
                description: "Introduction to software development life cycle, agile methodologies, and project management.",
                group: "CS2405A",
                credits: 3,
                lecturer: "Dr. Aminah Binti Ahmad",
                venue: "DK200 (Kompleks Kuliah)",
                time: "Mon 08:00 AM - 10:00 AM"
            },
            { 
                code: "ICT600", 
                name: "Data Science Essentials", 
                description: "Fundamental concepts of data science, including data manipulation, visualization, and basic machine learning.",
                group: "CS2405A",
                credits: 3,
                lecturer: "Assoc. Prof. Dr. Rahim",
                venue: "Makmal 3 (Fskm)",
                time: "Tue 02:00 PM - 04:00 PM"
            },
            { 
                code: "ENT530", 
                name: "Principles of Entrep.", 
                description: "Developing an entrepreneurial mindset, identifying business opportunities, and business planning.",
                group: "CS2405A", 
                credits: 2,
                lecturer: "Pn. Siti Sarah",
                venue: "Dewan Taming Sari",
                time: "Wed 10:00 AM - 12:00 PM"
            },
            { 
                code: "TMC401", 
                name: "Intro Mandarin I", 
                description: "Basic Mandarin language skills for beginners, focusing on conversation and basic characters.",
                group: "CS2405B", 
                credits: 2,
                lecturer: "Mr. Wong",
                venue: "Bilik Seminar 1",
                time: "Thu 08:00 AM - 10:00 AM"
            }
        ];

        let registeredCredits = 0;
        let registeredCoursesList = [];

        function filterCourses() {
            const input = document.getElementById('course-search');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('course-table');
            const tr = table.getElementsByTagName('tr');

            for (let i = 0; i < tr.length; i++) {
                const tdCode = tr[i].getElementsByTagName('td')[0];
                const tdName = tr[i].getElementsByTagName('td')[1];
                if (tdCode || tdName) {
                    const txtValueCode = tdCode.textContent || tdCode.innerText;
                    const txtValueName = tdName.textContent || tdName.innerText;
                    if (txtValueCode.toUpperCase().indexOf(filter) > -1 || txtValueName.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }       
            }
        }

        function renderCourses() {
            const tbody = document.getElementById('course-table');
            tbody.innerHTML = '';
            availableCourses.forEach((course, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${course.code}</strong></td>
                    <td>${course.name}</td>
                    <td>${course.group}</td>
                    <td>
                        <button class="btn btn-info" onclick="viewCourseDetails(${index})" title="View Details">
                            <i class="fas fa-eye"></i> Info
                        </button>
                    </td>
                    <td id="status-${index}"><span style="color:gray; font-size:0.9rem">Pending</span></td>
                    <td><button class="btn btn-primary" id="btn-add-${index}" onclick="addCourse(${index})">Add</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        renderCourses();

        // Function to Open Details Modal
        function viewCourseDetails(index) {
            const course = availableCourses[index];
            const contentDiv = document.getElementById('course-details-content');
            
            // Check if already registered to disable button in modal
            const isRegistered = document.getElementById(`btn-add-${index}`).disabled;
            const btnState = isRegistered ? 'disabled' : '';
            const btnText = isRegistered ? 'Registered' : 'Register Course';
            const btnClass = isRegistered ? 'btn-success' : 'btn-primary';

            contentDiv.innerHTML = `
                <div style="background: #f0f0f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: var(--uitm-purple); margin-bottom: 5px;">${course.code} - ${course.name}</h4>
                    <p style="font-size: 0.95rem; color: #555;">${course.description}</p>
                </div>
                
                <div class="detail-row"><span class="detail-label">Group:</span> <span class="detail-value">${course.group}</span></div>
                <div class="detail-row"><span class="detail-label">Credit Hrs:</span> <span class="detail-value">${course.credits}</span></div>
                <div class="detail-row"><span class="detail-label">Lecturer:</span> <span class="detail-value">${course.lecturer}</span></div>
                <div class="detail-row"><span class="detail-label">Location:</span> <span class="detail-value">${course.venue}</span></div>
                <div class="detail-row"><span class="detail-label">Time:</span> <span class="detail-value" style="color:#d9534f">${course.time}</span></div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn ${btnClass}" onclick="addCourseFromModal(${index})" ${btnState} id="modal-add-btn">
                        ${btnText}
                    </button>
                </div>
            `;
            
            document.getElementById('courseModal').classList.add('open');
        }

        function addCourseFromModal(index) {
            addCourse(index);
            closeModal('courseModal');
        }

        function addCourse(index) {
            const btn = document.getElementById(`btn-add-${index}`);
            const status = document.getElementById(`status-${index}`);
            
            if(btn.disabled) return; // Prevent double add

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            setTimeout(() => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                btn.innerText = "Added";
                btn.disabled = true;
                status.innerHTML = '<span style="color:green; font-weight:bold;">Registered</span>';
                
                const course = availableCourses[index];
                registeredCredits += course.credits;
                document.getElementById('credit-hours').innerText = registeredCredits;
                
                // Add to list and update dashboard
                registeredCoursesList.push(course);
                updateDashboard();
            }, 500);
        }

        function updateDashboard() {
            const listContainer = document.getElementById('dashboard-course-list');
            document.getElementById('dashboard-course-count').innerText = registeredCoursesList.length;
            
            if (registeredCoursesList.length === 0) {
                listContainer.innerHTML = '<li style="color: #999; text-align: center; padding: 10px;">No courses registered yet.</li>';
                return;
            }

            listContainer.innerHTML = '';
            registeredCoursesList.forEach(course => {
                const li = document.createElement('li');
                li.style.padding = '10px 0';
                li.style.borderBottom = '1px solid #eee';
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.innerHTML = `
                    <span><strong>${course.code}</strong></span>
                    <span style="color: #666; font-size: 0.85rem;">${course.group}</span>
                `;
                listContainer.appendChild(li);
            });
        }

        // --- 4. GENERAL UTILS ---
        function openPaymentModal() { document.getElementById('payModal').classList.add('open'); }
        function openDeferModal() { document.getElementById('deferModal').classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        function processPayment() {
            document.getElementById('full-balance').innerHTML = 'RM 0.00'; 
            document.getElementById('full-balance').style.color = 'green';
            document.getElementById('dash-balance').innerText = 'RM 0.00';
            closeModal('payModal');
            alert('Payment Successful!');
        }

        // --- NEW INTERACTIVE FUNCTIONS ---
        function toggleNotifications() {
            alert('You have 2 unread notifications:\n1. Fees payment due soon.\n2. New course announcement.');
        }

        function toggleProfileMenu() {
            document.getElementById('profileModal').classList.add('open');
        }

        function saveSettings() {
            const btn = document.getElementById('btn-save-settings');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }, 1000);
            
            // Dark Mode Logic (Prototype)
            const darkMode = document.getElementById('toggle-darkmode').checked;
            if(darkMode) {
                document.documentElement.style.setProperty('--bg-color', '#1a1a2e');
                document.documentElement.style.setProperty('--text-color', '#fff');
            } else {
                document.documentElement.style.setProperty('--bg-color', '#f4f6f9');
                document.documentElement.style.setProperty('--text-color', '#333');
            }
        }

        function openValidationModal() {
            document.getElementById('slip-date').innerText = new Date().toLocaleDateString();
            document.getElementById('slip-credits').innerText = registeredCredits;
            document.getElementById('validationModal').classList.add('open');
        }
        
        // Update Deferment Submit
        document.querySelector('#deferModal .btn-primary').onclick = function() {
            const btn = this;
            btn.innerText = "Submitting...";
            setTimeout(() => {
                closeModal('deferModal');
                alert('Deferment application submitted for review.');
                btn.innerText = "Submit";
            }, 800);
        };

        // --- 5. CHAT SYSTEM ---
        function toggleChat() {
            const box = document.getElementById('chat-box');
            box.style.display = (box.style.display === 'flex') ? 'none' : 'flex';
        }
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const body = document.getElementById('chat-body');
            if(!input.value) return;
            
            body.innerHTML += `<div class="chat-msg msg-user">${input.value}</div>`;
            input.value = '';
            body.scrollTop = body.scrollHeight;
            
            setTimeout(() => {
                body.innerHTML += `<div class="chat-msg msg-bot">Please check the 'Course Details' button for timetable info.</div>`;
                body.scrollTop = body.scrollHeight;
            }, 1000);
        }

        // --- 6. TIMER ---
        const deadline = new Date(); deadline.setDate(deadline.getDate() + 2);
        setInterval(() => {
            const now = new Date().getTime();
            const dist = deadline - now;
            const h = Math.floor((dist % (86400000)) / 3600000);
            const m = Math.floor((dist % 3600000) / 60000);
            const s = Math.floor((dist % 60000) / 1000);
            document.getElementById("timer").innerHTML = `${h}h ${m}m ${s}s`;
        }, 1000);

    </script>
</body>
</html>